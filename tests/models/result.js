var should = require('should')
  , Workout = require('../../assets/js/models/workout.js')
  , Task = require('../../assets/js/models/task.js')
  , Result = require('../../assets/js/models/result/result.js')
  , WeightResult = require('../../assets/js/models/result/weight')
  , movements = require('../../assets/data/movements.js')
  , _ = require('underscore')

describe('Data', function(){
  describe('Result', function(){
    var workout
    beforeEach(function(){
      workout = new Workout()
      should.exist(workout)
      workout.tasks.add(new Task('box jump'))
      workout.tasks.add(new Task('clean and jerk'))
      workout.tasks.length.should.be.equal(2)
    })
    it('should create a workout', function(){
      workout.set('type', 'rounds')
      workout.result.get('type').should.be.equal('rounds')
      should.exist(workout.result.get('metric'))
      workout.result.get('metric').get('value').should.equal(0)
    })
    it('should be a part of the workout json', function(){
      var o = workout.toJSON()
      should.exist(o)
      should.exist(o.result)
      should.exist(o.result.metrics)
      should.exist(o.result.metrics.duration)
      should.exist(o.result.metrics.duration.value)
      should.exist(o.result.metrics.duration.units)
    })
    it('should allow rounds to be stringified', function(){
      workout.set('type', 'weight')
      var set = workout.result.get('metric').get('sets').last()
      var o = set.toJSON()
      should.exist(o)
      should.exist(o.metrics.weight)
      should.exist(o.metrics.reps)
    })
    it('should have taks in the result for weight workouts', function(){
      workout.set('type', 'weight')
      should.exist(workout.result.get('metric'))
      should.exist(workout.result.get('metric').get('sets'))
      workout.result.get('metric').should.be.instanceOf(WeightResult)
      var o = workout.toJSON()
      should.exist(o)
      should.exist(o.result)
      should.exist(o.result.sets)
      o.result.sets.should.be.instanceOf(Array)
    })
    it('should have a round for each task', function(){
      workout.set('type', 'weight')
      workout.result.get('metric').get('sets').length.should.be.equal(1)
      workout.tasks.length.should.be.equal(1)
      var task = workout.tasks.first()
      workout.tasks.remove(task)
      workout.result.get('metric').get('sets').length.should.be.equal(0)
      workout.tasks.length.should.be.equal(0)
    })
    it('should reorder sets for weighted workouts', function(){
      workout.set('type', 'weight')
      workout.tasks.add(new Task('clean and jerk'))
      workout.tasks.add(new Task('clean and jerk'))
      var set = workout.result.get('metric').get('sets').last()
      var order = set.get('order')
      workout.tasks.last().moveUp()
      set.get('order').should.not.be.equal(order)
    })
    it('should properly assign `set` metrics from tasks', function(){
      workout.set('type', 'weight')
      workout.tasks.add(new Task('clean and jerk'))
      workout.tasks.add(new Task('clean and jerk'))
      var set = workout.result.get('metric').get('sets').last()
      var o = set.toJSON()
      should.exist(o.metrics.weight)
      should.exist(o.metrics.weight.value)
      should.exist(o.metrics.weight.units)
    })
    it('should update a result set item if the task reps change', function(){
      workout.set('type', 'weight')
      workout.tasks.remove()
      workout.tasks.add(new Task('clean and jerk'))
      workout.tasks.add(new Task('clean and jerk'))
      var set = workout.result.get('metric').get('sets').first().toJSON()
      var task = workout.tasks.first()
      var taskMetric = task.metrics.findWhere({name:'reps'}).toJSON()
      should.exist(taskMetric)
      should.exist(taskMetric.value)
      should.exist(set.metrics)
      should.exist(set.metrics.reps)
      should.exist(set.metrics.reps.value)
      taskMetric.value.should.equal(set.metrics.reps.value)
      workout.tasks.first().metrics.findWhere({name:'reps'}).set('value', 99)
      workout.tasks.last().metrics.findWhere({name:'reps'}).get('value').should.not.equal(99)
      var sets = workout.result.get('metric').get('sets')
      sets.first().get('reps').should.not.equal(sets.last().get('reps'))
      sets.first().get('reps').value.should.equal(99)
      sets.first().should.not.equal(sets.last())
      sets.last().get('reps').value.should.not.equal(99)
    })
  })
})